<html>
<script>
var AudioContext = window.AudioContext 
  || window.webkitAudioContext;
var audioContext = new AudioContext();

async function playOne(url, n) {
  console.log("TEST: playOne()");
  try {
    let length = 0;
    let numberOfChannels = 2;
    let sampleRate = 48000;
    let res = await fetch(url);
    if (!res.ok) {
       throw new Error(`TEST: playOne() ${e.message}`);
    }
    let urlBuf = await res.arrayBuffer();
    let emsg = document.getElementById("emsg");
    emsg.innerHTML = n+"new AudioContext";
    emsg.innerHTML = n+"createBufferSource";
    let audioSource = audioContext.createBufferSource();
    emsg.innerHTML = n+"decodeAudioData";
    let urlAudio = await new Promise((resolve, reject)=>{
      audioContext.decodeAudioData(urlBuf, resolve, reject);
    });
    numberOfChannels = Math.min(numberOfChannels, urlAudio.numberOfChannels);
    length += urlAudio.length;
    sampleRate = Math.max(sampleRate, urlAudio.sampleRate);
    console.log(`${n}playOne()`, {sampleRate, length, numberOfChannels});

    msg = [
      `audioContext.createBuffer`,
      JSON.stringify({numberOfChannels, length, sampleRate}),
    ].join(' ');
    emsg.innerHTML = n+msg;
    let audioBuffer = audioContext.createBuffer(numberOfChannels, length, sampleRate);
    emsg.innerHTML = n+'audioBuffer created';
    for (let channelNumber = 0; channelNumber < numberOfChannels; channelNumber++) {
      let offset = 0;
      msg = [
        `new Float32Array`,
        typeof Float32Array,
        typeof window.Float32Array,
        Float32Array == null ? "null" : "OK",
      ].join(' ');
      emsg.innerHTML = n+msg;
      let channelData = new Float32Array(length);
      channelData.set(urlAudio.getChannelData(channelNumber), offset);
      offset += urlAudio.length;
      audioBuffer.getChannelData(channelNumber).set(channelData);
    }

    audioSource.buffer = audioBuffer;
    emsg.innerHTML = n+'connect';
    audioSource.connect(audioContext.destination);
    return new Promise((resolve, reject) => { try {
      audioSource.onended = evt => {
        console.log(`TEST: onended OK`);
        emsg.innerHTML = n+'onended OK';
        resolve();
      };
      emsg.innerHTML = n+'start()';
      audioSource.start();
      console.log(`TEST: started`);
    } catch(e) {
      alert(`TEST: onended ${e.message}`);
    }});
    emsg.innerHTML = 'playOne => OK';
  } catch(e) {
      console.error(`TEST: failed ${e.message}`, e);
      alert(e.message);
      reject(e);
  }
}

async function onClickPlay() {
  console.log("TEST: onClickPlay()");
  let url = "https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229";
  let url2 = "https://voice.suttacentral.net/scv/audio/mn1/en/sujato/Amy/b627aa0151c721837225614412434a77";
  await this.playOne(url, 1);
  await this.playOne(url2, 2);
  await this.playOne(url, 3);
}
</script>
<body>
  <h1>TEST AUDIO</h1>
  <div style="display: flex; flex-flow: column; align-items: center;">
    <div>
      <a href="https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229" target="_blank">
      https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229
      </a>
    </div>
    <div id="emsg">EMSG</div>
    <audio controls>
      <source type="audio/mp3"
        src="https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229"></source>
    </audio>
    <button onclick="onClickPlay()">
      Play
    </button>
  </div>
</body>
</html>
