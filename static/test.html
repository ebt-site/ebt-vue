<html>
<script>
async function onClickPlay() {
  console.log("TEST: onClickPlay()");
  let url = "https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229"
  try {
    let length = 0;
    let numberOfChannels = 2;
    let sampleRate = 48000;
    let res = await fetch(url);
    if (!res.ok) {
       throw new Error(`TEST: onClickPlay() ${e.message}`);
    }
    let urlBuf = await res.arrayBuffer();
    let AudioContext = window.AudioContext 
      || window.webkitAudioContext;
    let AudioBuffer = window.AudioBuffer 
      || window.webkitAudioBuffer;
    alert('new AudioContext');
    let audioContext = new AudioContext();
    alert('createBufferSource');
    let audioSource = audioContext.createBufferSource();
    alert('decodeAudioData');
    let urlAudio = await new Promise((resolve, reject)=>{
      audioContext.decodeAudioData(urlBuf, resolve, reject);
    });
    numberOfChannels = Math.min(numberOfChannels, urlAudio.numberOfChannels);
    length += urlAudio.length;
    sampleRate = Math.max(sampleRate, urlAudio.sampleRate);

    msg = [
      `new AudioBuffer`,
      JSON.stringify({length, numberOfChannels, sampleRate}),
      typeof AudioBuffer,
      AudioBuffer == null ? "null" : "OK",
    ].join(' ');
    alert(msg);
    let audioBuffer = new AudioBuffer({length, numberOfChannels, sampleRate})
    for (let channelNumber = 0; channelNumber < numberOfChannels; channelNumber++) {
      let offset = 0;
      console.log('new Float32Array');
      let channelData = new Float32Array(length);
      channelData.set(urlAudio.getChannelData(channelNumber), offset);
      offset += urlAudio.length;
      audioBuffer.copyToChannel(channelData, channelNumber);
    }

    audioSource.buffer = audioBuffer;
    alert('connect');
    audioSource.connect(audioContext.destination);
    alert('start');
    audioSource.start();
    alert('play done');
  } catch(e) {
      console.error(`TEST: failed ${e.message}`, e);
      alert(e.message);
  }
}
</script>
<body>
  <h1>TEST AUDIO</h1>
  <div style="display: flex; flex-flow: column; align-items: center;">
    <div>
      <a href="https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229" target="_blank">
      https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229
      </a>
    </div>
    <audio controls>
      <source type="audio/mp3"
        src="https://voice.suttacentral.net/scv/audio/dn34/en/sujato/Amy/ec017f3bba333bd764e6dbf9c50da229"></source>
    </audio>
    <button onclick="onClickPlay()">
      Play
    </button>
  </div>
</body>
</html>
